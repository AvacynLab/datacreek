{% extends 'base.html' %}

{% block title %}Dataset {{ dataset.name }}{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/3d-force-graph@1.77.0/dist/3d-force-graph.min.js"></script>
<style>#graph{height:600px}</style>
{% endblock %}

{% block content %}
<h2>{{ dataset.name }}</h2>
<ul class="nav nav-tabs" id="myTab" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="raw-tab" data-bs-toggle="tab" data-bs-target="#raw" type="button" role="tab">Donnée brute</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="kg-tab" data-bs-toggle="tab" data-bs-target="#kg" type="button" role="tab">Knowledge Graph</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="gen-tab" data-bs-toggle="tab" data-bs-target="#gen" type="button" role="tab">Génération</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="cur-tab" data-bs-toggle="tab" data-bs-target="#cur" type="button" role="tab">Curation</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="exp-tab" data-bs-toggle="tab" data-bs-target="#exp" type="button" role="tab">Exportation</button>
  </li>
</ul>
<div class="tab-content mt-3">
  <div class="tab-pane fade show active" id="raw" role="tabpanel">
    <form class="mb-3" method="post" action="{{ url_for('dataset_ingest', name=dataset.name) }}">
      <div class="mb-3">
        <label for="inputPath" class="form-label">Path or URL</label>
        <input type="text" class="form-control" id="inputPath" name="input_path" placeholder="/path/to/file or URL" required>
      </div>
      <div class="mb-3">
        <label for="docId" class="form-label">Document ID (optional)</label>
        <input type="text" class="form-control" id="docId" name="doc_id">
      </div>
      <button type="submit" class="btn btn-primary">Ingest</button>
    </form>

    {% if dataset.graph.graph.nodes %}
    <h5>Documents</h5>
    <ul>
    {% for node, data in dataset.graph.graph.nodes(data=True) if data.type == 'document' %}
      <li>{{ node }} ({{ dataset.graph.get_chunks_for_document(node)|length }} chunks)</li>
    {% endfor %}
    </ul>
    {% else %}
    <p class="text-muted">No documents yet.</p>
    {% endif %}
  </div>
  <div class="tab-pane fade" id="kg" role="tabpanel">
    <div class="mb-2">
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" id="toggleDocs" checked>
        <label class="form-check-label" for="toggleDocs">Documents</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" id="toggleChunks" checked>
        <label class="form-check-label" for="toggleChunks">Chunks</label>
      </div>
    </div>
    <div id="graph" style="height: 600px;"></div>
  </div>
  <div class="tab-pane fade" id="gen" role="tabpanel">
    <p class="text-muted">Generation parameters placeholder.</p>
  </div>
  <div class="tab-pane fade" id="cur" role="tabpanel">
    <p class="text-muted">Curation operations placeholder.</p>
  </div>
  <div class="tab-pane fade" id="exp" role="tabpanel">
    <p class="text-muted">Export options placeholder.</p>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
const container = document.getElementById('graph');
fetch("{{ url_for('dataset_graph', name=dataset.name) }}")
  .then(res => res.json())
  .then(data => {
    const DOC_COLOR = '#1f77b4';
    const CHUNK_COLOR = '#ff7f0e';
    const Graph = ForceGraph3D()(container)
      .graphData(data)
      .nodeLabel(n => `${n.id} (${n.type})`)
      .linkColor(() => '#999');

    function applyFilters() {
      const showDocs = document.getElementById('toggleDocs').checked;
      const showChunks = document.getElementById('toggleChunks').checked;
      Graph
        .nodeColor(node => {
          if (node.type === 'document' && !showDocs) return '#ccc';
          if (node.type === 'chunk' && !showChunks) return '#ccc';
          return node.type === 'document' ? DOC_COLOR : CHUNK_COLOR;
        })
        .linkColor(link => {
          const sType = typeof link.source === 'object' ? link.source.type : data.nodes.find(n => n.id === link.source).type;
          const tType = typeof link.target === 'object' ? link.target.type : data.nodes.find(n => n.id === link.target).type;
          if ((sType === 'document' && !showDocs) || (sType === 'chunk' && !showChunks) ||
              (tType === 'document' && !showDocs) || (tType === 'chunk' && !showChunks)) {
            return '#ccc';
          }
          return '#999';
        });
    }

    applyFilters();
    document.getElementById('toggleDocs').addEventListener('change', applyFilters);
    document.getElementById('toggleChunks').addEventListener('change', applyFilters);
  });
</script>
{% endblock %}
